@using LinkClanBot3.Data
@inject LinkClanBot3Context DBContext
@inject IDialogService DialogService

<MudText>@getJoinTime()</MudText>

@code {
	[Parameter]
	public int MonthsAgo { get; set; } = 0;
	[Parameter]
	[EditorRequired]
	public string MemberId { get; set; } = "";

	private double getJoinTime()
	{
		DateTime dtToday = DateTime.Today.AddMonths(MonthsAgo);
		var from = new DateTime(dtToday.Year, dtToday.Month, 1);
		var to = new DateTime(dtToday.Year, dtToday.Month,
			DateTime.DaysInMonth(dtToday.Year, dtToday.Month), 12, 59, 59);

		var timeLines = DBContext.MemberTimeLine
			.Where(e => from <= e.EventDate && to >= e.EventDate && e.MemberID == MemberId)
			.Take(10000)
			.OrderBy(e => e.MemberData)
			.ToList();

		double sum = 0.0;
		var startIndex = 0;
		foreach (var line in timeLines.Select((value, index) => new { index, value }))
		{
			if (line.value.EnteringRoom == EnteringRoom.Exit)
			{
				var startItem = timeLines.TakeLast(timeLines.Count - startIndex).Take(line.index).FirstOrDefault(e => e.EnteringRoom == EnteringRoom.Entry);
				if (startItem != null)
				{
					// 退出があれば、退出時間と入室時間の差分を計算する
					sum += Math.Max((line.value.EventDate - startItem.EventDate).TotalHours, 0);
					startIndex = line.index;
				}
			}
		}
		return Math.Round(sum, 2);
	}
}
